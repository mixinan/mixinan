<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>饺子联盟</title>
<script type="text/javascript" src="js/jquery-1.11.3.js"></script>
<script type="text/javascript" src="js/cookie_util.js"></script>
<script type="text/javascript" src="js/const.js"></script>
<script type="text/javascript" src="js/blog.js"></script>
<style>
	ul{
	   list-style:none;
	}
</style>
</head>
<body>
	<span id="user_name">user name</span> 
	<a id="logout" href="javascript:logout()">退出</a>
	
	<!-- 搜索部分 -->
	<input placeholder="输入关键字" id="kw"> <button id="bt_search">搜索</button>
	
	<h3>欢迎来到 饺子联盟 官网</h3>
	
	<p id="input_parent">
		<input id="blogText" placeholder="请输入blogText" />
		<button id="bt_send">发送</button>
	</p>
	
	<ul id="blog_list">
	
	
		<!-- blog列表, ajax填充 -->
		
		
	</ul>
	
	<script>
	
	//退出
	var logout = function(){
		delCookie("userName");
		delCookie("userId");
		window.location.href="login.html";
	}
	
	
	$(function(){
		//获取用户信息
		var userName = getCookie("userName");
		var userId = getCookie("userId");
		//alert("id "+userId+" name "+userName);
		
		
		//如果没登录，只显示blogs，不显示“输入框和发送按钮”
		if(userId==null){
			$("#input_parent").hide();
			$("#logout").html("登录");
		}
		
		
		
		var $list = $("#blog_list");
		
		
		
		//在顶部显示用户名
		$("#user_name").html(userName);
		
		/*打开页面，加载所有blog，此方法封装在（blog.js）*/
		getAllBlogs();
		
		
		
		
		
		//点击按钮，发送内容到数据库
		$("#bt_send").click(function(){
			var $input = $("#blogText");
			var blogText = $input.val().trim();
			console.log(blogText);
			
			$.ajax({
				type:"post",
				url:path+"/blog/addblog.do",
				data:{"userId":userId,"blogText":blogText},
				dataType:"json",
				success:function(result){
					console.log(result.status);
					console.log(result.msg);
					//console.log(result.data);
					//发送完毕后，清空输入框内容
					$input.val("");
					//getAllBlogs();
					$list.prepend($("<li>"+userId+"："+blogText+"</li>"));
				},
				error:function(){
					console.log(result.status);
					console.log(result.msg);
					console.log(result.data);
				}
			});
			
		});
		
		
		
		
		//点击搜索按钮
		$("#bt_search").click(function(){
			//获取参数kw
			var $kw = $("#kw");
			var kw = $kw.val().trim();
			console.log("keyword: "+kw);
			
			$.ajax({
				type:"post",
				url:path+"/blog/searchblogs.do",
				data:{"kw":kw},
				dataType:"json",
				success:function(result){
					$list.html("");
					
					var list=result.data;
					var listSize = list.length;
					
					console.log(result.status);
					console.log(result.msg);
					
					for(var i=0;i<listSize;i++){
						var blog = list[i];
						console.log(blog.mi_blog_text);
						
						$li = $("<li>"+blog.mi_blog_text+"</li>");
						
						// 将blogId绑定在 $li（注意：jQuery对象）上
						$li.data("blogId", blog.mi_blog_id);
						
						$list.prepend($li);
					}
					//console.log(result.data);
					//搜索完毕后，清空输入框内容
					$kw.val("");
				},
				error:function(){
					console.log(result.status);
					console.log(result.msg);
					console.log(result.data);
				}
			});
			
		});
		
		
		
	});
		
	</script>
</body>
</html>